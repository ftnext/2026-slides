Rust è£½ãƒªãƒ³ã‚¿ã«ãƒ«ãƒ¼ãƒ«ã‚’ã©ã†è¿½åŠ ã™ã‚‹ã‹
==================================================

Ruff
--------------------------------------------------

* https://github.com/astral-sh/ruff

    An extremely fast Python linter and code formatter, written in Rust.

* flake8 ã‚„ pylint ã¨æ¯”ã¹ã¦åœ§å€’çš„ã« **é€Ÿã„**

.. ãƒã‚¤ãƒŠãƒª vs ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ï¼šã“ã®é•ã„ãŒé€Ÿã•ã®ä¸€å› 

Astralã€ŒRuff ã ã‘ã‚ã‚Œã°ã„ã„ã§ã—ã‚‡ã€
--------------------------------------------------

* æ•°ã€…ã®ãƒªãƒ³ã‚¿ãƒ»ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’ Ruff ã«çµ±åˆ

    Ruff can be used to replace Flake8 (plus dozens of plugins), Black, isort, pydocstyle, pyupgrade, autoflake, and more,

* ãƒ«ãƒ¼ãƒ«ã‚’å†å®Ÿè£…ã—ã€800è¶…ãˆã‚’ã‚«ãƒãƒ¼ [#ruff-rules-doc]_

.. [#ruff-rules-doc] ã€Œ*Ruff supports over 800 lint rules,*ã€https://docs.astral.sh/ruff/rules/

.. ä½¿ã„æ–¹ä¾‹ ã‚³ãƒãƒ³ãƒ‰
.. https://nikkie-ftnext.hatenablog.com/entry/ruff-as-python-formatter-two-commands
.. https://gihyo.jp/article/2023/03/monthly-python-2303

Ruff ã«ã¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ©Ÿæ§‹ãŒç„¡ã„ğŸˆšï¸
--------------------------------------------------

* `Meta issue: plugin system #283 <https://github.com/astral-sh/ruff/issues/283>`__ (2023/09 2å¹´åŠä»¥ä¸Šã‚ªãƒ¼ãƒ—ãƒ³ã€‚*æ”¾ç½®*ï¼Ÿ)
* è‡ªåˆ†ã«å¿…è¦ãªãƒ«ãƒ¼ãƒ«ã‚’æ‰‹å…ƒã§è¿½åŠ ã§ããªã„ï¼ˆã„ããªã‚Šæœ¬å®¶ã¸ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãªã‚‹ï¼‰
* ç‡ç›´ã«å›°ã‚Šã¾ã›ã‚“ã‹ï¼Ÿé€Ÿã•ã‚’å„ªå…ˆã™ã‚‹ã¨ã€æ©Ÿèƒ½ã®è±Šã‹ã•ã‚’å¤±ã†ï¼ˆRuffã‚„Astralã¯ã‚‚ã£ã¨ã†ã¾ãç«‹ã¡å›ã‚Œã‚‹ã¯ãšï¼‰

.. https://github.com/astral-sh/ruff/issues/283#issuecomment-2354996290

.. https://nikkie-ftnext.hatenablog.com/entry/is-ruff-superset-of-flake8-my-answer-is-no-202501

Ruff + ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ« ã‚’ã©ã†å®Ÿç¾ã™ã‚‹ã‹ï¼Ÿ
--------------------------------------------------

* flake8ï¼ˆã‚„pylintï¼‰ã¨ã®ä½µç”¨ã¯ãªã„ã€‚ã›ã£ã‹ãã®é€Ÿã•ã‚’å¤±ã†
* **é«˜é€Ÿã•ã‚’æãªã‚ãšã«ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ã‚’æ›¸ãæ–¹æ³•ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹** ï¼ˆã‚¢ã‚¤ãƒ‡ã‚¢å‹Ÿé›†ã€‚å»Šä¸‹å¸Œæœ›ï¼‰

IMOï¼šä»£æ›¿æ‰‹æ®µ
--------------------------------------------------

* ast-grep: Rustè£½ãƒ„ãƒ¼ãƒ«ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ã‚’YAMLã§æ›¸ã
* Rust ã§ç›´æ¥æ›¸ã„ã¦ã¿ã‚‹: RustPython/Parser

ast-grep
==================================================

* https://github.com/ast-grep/ast-grep

    ast-grep is an abstract syntax tree based tool to search code by pattern code.

* **ASTã§grep** ã§ãã‚‹ï¼

ä½¿ã„æ–¹ï¼ˆä¸€ä¾‹ï¼‰
--------------------------------------------------

.. code-block:: console

    $ uvx --from ast-grep-cli ast-grep scan --rule ast-grep-kotoha.yaml examples.py

https://pypi.org/project/ast-grep-cli/

YAMLã§ãƒ«ãƒ¼ãƒ«ã‚’æ›¸ã
--------------------------------------------------

.. literalinclude:: ../../samplecode/write-python-linter-rules/kotoha.yaml
   :language: yaml

ast-grepã«ãŠã‘ã‚‹AST
--------------------------------------------------

.. code-block:: python

    def plus_one_ng(numbers: list[str]) -> list[int]: pass

.. literalinclude:: ../../samplecode/write-python-linter-rules/lint-targets/tree-sitter-output
   :lines: 2-12

https://ast-grep.github.io/playground.html

``list[]`` ã¨ã„ã†å‹ãƒ’ãƒ³ãƒˆã«ãƒãƒƒãƒ
--------------------------------------------------

.. literalinclude:: ../../samplecode/write-python-linter-rules/kotoha.yaml
   :language: yaml
   :lines: 3-6

.. https://ast-grep.github.io/guide/rule-config.html

è¦ªãƒãƒ¼ãƒ‰ã®æŒ‡å®šã‚’è¿½åŠ 
--------------------------------------------------

typed_parameter ã®ç›´ä¸‹ã® type

.. literalinclude:: ../../samplecode/write-python-linter-rules/kotoha.yaml
   :language: yaml
   :lines: 3-8
   :emphasize-lines: 5-6

ASTã¯å®Ÿã¯tree-sitterã«ã‚ˆã‚‹
--------------------------------------------------

    ast-grep's core is an algorithm to search and replace code based on abstract syntax tree produced by tree-sitter. 

* tree-sitter ã¯å¤šè¨€èªå¯¾å¿œ
* https://tree-sitter.github.io/tree-sitter/

.. https://nikkie-ftnext.hatenablog.com/entry/tree-sitter-python-query-like-flake8-kotoha

tree-sitter ã‚¯ã‚¨ãƒªã®ä¾‹
--------------------------------------------------

.. literalinclude:: ../../samplecode/write-python-linter-rules/kotoha.scm
   :language: scheme

ç™ºå±•ï¼šRust ã§æ›¸ã
==================================================

* ã“ã®éƒ¨åˆ†ã ã‘ Rust ã®çŸ¥è­˜ã‚’å‰æã«ã—ã¾ã™
* é›°å›²æ°—ã ã‘æ´ã‚“ã§ã„ãŸã ã‘ã‚Œã°ï¼

RustPython/Parser ã¨ã¯
--------------------------------------------------

* RustPython ã‚„ Ruff ãŒå†…éƒ¨ã§ä½¿ã† Python ãƒ‘ãƒ¼ã‚µãƒ¼ï¼ˆRustè£½ï¼‰
* Ruff ã¯ 0.4.10 é ƒã‹ã‚‰è‡ªå‰ãƒ‘ãƒ¼ã‚µãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆãŸãŒã€ä¸€æ—¦ã“ã¡ã‚‰ã‚’ä½¿ã†
* Ruff ã®ãƒ«ãƒ¼ãƒ«ã‚‚ã€åŒã˜æ¦‚å¿µã®ãƒ‘ãƒ¼ã‚µãƒ¼ãŒç”Ÿæˆã™ã‚‹ AST ã‚’æ‰±ã£ã¦ã„ã‚‹

Rust ç’°å¢ƒã®æœ€å°é™ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
--------------------------------------------------

* ``rustup`` ã§ Rust ç’°å¢ƒã‚’å°å…¥
* ``cargo`` ã¯ Python ã§ã„ã† ``uv`` ã®ã‚ˆã†ãªã‚‚ã®ï¼ˆ``pip`` + ``venv`` ã«ç›¸å½“ï¼‰
* ``cargo init`` ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
* ``cargo add rustpython-parser`` ã§ä¾å­˜è¿½åŠ 

Python ã‚³ãƒ¼ãƒ‰ã‚’ Rust ã§ãƒ‘ãƒ¼ã‚¹ã™ã‚‹
--------------------------------------------------

* Python å´: ``ast.dump(ast.parse(source))``
* Rust å´: ``parse(source, Mode::Module)`` + ``println!("{:#?}", ast)``

AST è¡¨ç¾ã®æ¯”è¼ƒ
--------------------------------------------------

* Python ã® AST ã¨ Rust ã® AST ã¯åŒã˜æ¦‚å¿µã‚’ç•°ãªã‚‹è¡¨ç¾ã§æŒã¤

  * Python: ``FunctionDef``, ``arg``, ``Subscript``
  * Rust: ``StmtFunctionDef``, ``Parameter``, ``Expr::Subscript``

* ã“ã® AST ã‚’è¾¿ã£ã¦ã€Pythonç‰ˆã¨åŒæ§˜ã®åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã‚’ Rust ã§æ›¸ã‘ã‚‹

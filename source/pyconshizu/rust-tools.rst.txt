Rustè£½ãƒªãƒ³ã‚¿ã«ãƒ«ãƒ¼ãƒ«ã‚’ã©ã†è¿½åŠ ã™ã‚‹ã‹
==================================================

Pythonã§ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã‚‚ã®ã®...

Ruffï¼ˆå›³ã¯READMEã‚ˆã‚Šï¼‰
--------------------------------------------------

* https://github.com/astral-sh/ruff

    An extremely fast Python linter and code formatter, written in Rust.

.. image:: https://user-images.githubusercontent.com/1309177/232603514-c95e9b0f-6b31-43de-9a80-9e844173fd6a.svg

.. Ruffã® `README <https://github.com/astral-sh/ruff/blob/main/README.md>`__ ã®å›³ (ç™ºè¡¨æ™‚ 0.15.2)

.. ãƒã‚¤ãƒŠãƒª vs ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ï¼šã“ã®é•ã„ãŒé€Ÿã•ã®ä¸€å› 

Astralã€ŒRuff ã ã‘ã‚ã‚Œã°ã„ã„ã§ã—ã‚‡ã€
--------------------------------------------------

* æ•°ã€…ã®ãƒªãƒ³ã‚¿ãƒ»ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ã‚’Ruffã« **çµ±åˆ**

    Ruff can be used to replace Flake8 (plus dozens of plugins), Black, isort, pydocstyle, pyupgrade, autoflake, and more,

* ãƒ«ãƒ¼ãƒ«ã‚’å†å®Ÿè£…ã—ã€800è¶…ãˆã‚’ã‚«ãƒãƒ¼ [#ruff-rules-doc]_

.. [#ruff-rules-doc] ã€Œ*Ruff supports over 800 lint rules,*ã€ https://docs.astral.sh/ruff/rules/

ã‚³ãƒãƒ³ãƒ‰ä¾‹ [#ruff-command-article]_
--------------------------------------------------

.. code-block:: console

    uvx ruff format
    uvx ruff check --fix --extend-select I
    # ã¾ãŸã¯ uv format  # >= 0.8.13

æ˜¨æ—¥ã® `Ruff 0.15.2 <https://github.com/astral-sh/ruff/releases/tag/0.15.2>`__ ã‹ã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒ«ãŒ **çˆ†å¢—** ã—ã¦ã¾ã™

.. https://github.com/astral-sh/uv/releases/tag/0.8.13

.. [#ruff-command-article] æ‹™ãƒ–ãƒ­ã‚° `Ruffã¯ format ã¨ check --fix ã®2ã¤ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹ <https://nikkie-ftnext.hatenablog.com/entry/ruff-as-python-formatter-two-commands>`__

.. https://gihyo.jp/article/2023/03/monthly-python-2303

Ruffã«ã¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ©Ÿæ§‹ãŒç„¡ã„ğŸˆšï¸
--------------------------------------------------

* ãƒ«ãƒ¼ãƒ«ã®è¿½åŠ ã¯ã€æœ¬å®¶ã¸ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¡ˆå†…ã•ã‚Œã‚‹ï¼ˆ`CONTRIBUTING.md <https://github.com/astral-sh/ruff/blob/main/CONTRIBUTING.md>`__ï¼‰
* `Meta issue: plugin system #283 <https://github.com/astral-sh/ruff/issues/283>`__ (2023/09 2å¹´åŠä»¥ä¸Šã‚ªãƒ¼ãƒ—ãƒ³ã€‚*æ”¾ç½®*ï¼Ÿ)
* è‡ªåˆ†ã«å¿…è¦ãªãƒ«ãƒ¼ãƒ«ã‚’ **æ‰‹å…ƒã§Ruffã«è¿½åŠ ã§ããªã„** çŠ¶æ…‹

Why Astral?
--------------------------------------------------

* é«˜é€Ÿãƒ„ãƒ¼ãƒ«ã«æœ€å¤§ç´šã®æ„Ÿè¬ã‚’ç¤ºã—ã¤ã¤ã‚‚ã€ç‡ç›´ã«è¨€ã£ã¦å›°ã£ã¦ã¾ã™
* æ‹™ãƒ–ãƒ­ã‚° `Ruffã¯Flake8ã®å…¨ã¦ã®è¦ç´ ã‚’å«ã‚“ã§ã„ã‚‹ã€ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ <https://nikkie-ftnext.hatenablog.com/entry/is-ruff-superset-of-flake8-my-answer-is-no-202501>`__ â€• å¦ï¼ˆäº’æ›ã§ãªã„ï¼‰
* **é€Ÿã•ã‚’å„ªå…ˆã™ã‚‹ã¨ã€æ©Ÿèƒ½ã®è±Šã‹ã•ã‚’å¤±ã†** ï¼ˆRuffã‚„Astralã¯ã‚‚ã£ã¨ã†ã¾ãç«‹ã¡å›ã‚Œã‚‹ã¯ãšï¼‰

.. https://github.com/astral-sh/ruff/issues/283#issuecomment-2354996290

Ruff + ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ« ã‚’ã©ã†å®Ÿç¾ã™ã‚‹ã‹ï¼Ÿ
--------------------------------------------------

* flake8ï¼ˆã‚„pylintï¼‰ã¨ã®ä½µç”¨ã¯ãªã„ã€‚ã›ã£ã‹ãã®é€Ÿã•ã‚’å¤±ã†
* **é«˜é€Ÿã•ã‚’æãªã‚ãšã«ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ã‚’æ›¸ãæ–¹æ³•** ã‚’æ±‚ã‚ã¦ã¾ã™ï¼ˆã‚¢ã‚¤ãƒ‡ã‚¢å‹Ÿé›†ã€‚å»Šä¸‹å¸Œæœ›ï¼‰

IMOï¼šä»£æ›¿æ‰‹æ®µ
--------------------------------------------------

A. ast-grep: Rustè£½ãƒ„ãƒ¼ãƒ«ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ã‚’ **YAML** ã§æ›¸ã
B. **Rust** ã§ç›´æ¥æ›¸ã„ã¦ã¿ã‚‹: RustPython/Parser

ğŸ…°ï¸ ast-grep
==================================================

* https://github.com/ast-grep/ast-grep

    ast-grep is an abstract syntax tree based tool to search code by pattern code.

* **ASTã§grep** ã§ãã‚‹ï¼

ä½¿ã„æ–¹ï¼ˆä¸€ä¾‹ï¼‰
--------------------------------------------------

.. code-block:: console

    $ uvx --from ast-grep-cli ast-grep scan --rule ast-grep-kotoha.yaml examples.py

https://pypi.org/project/ast-grep-cli/

YAMLã§ãƒ«ãƒ¼ãƒ«ã‚’æ›¸ã
--------------------------------------------------

.. literalinclude:: ../../samplecode/write-python-linter-rules/kotoha.yaml
   :language: yaml

ast-grepã«ãŠã‘ã‚‹AST
--------------------------------------------------

.. code-block:: python

    def plus_one_ng(numbers: list[str]) -> list[int]: pass

.. literalinclude:: ../../samplecode/write-python-linter-rules/lint-targets/tree-sitter-output
   :lines: 2-12

https://ast-grep.github.io/playground.html

``list[]`` ã¨ã„ã†å‹ãƒ’ãƒ³ãƒˆã«ãƒãƒƒãƒ
--------------------------------------------------

.. literalinclude:: ../../samplecode/write-python-linter-rules/kotoha.yaml
   :language: yaml
   :lines: 3-6

.. image:: ../_static/pyconshizu/ast-grep-playground-list-type-hint.png

.. https://ast-grep.github.io/guide/rule-config.html

è¦ªãƒãƒ¼ãƒ‰ã®æŒ‡å®šã‚’è¿½åŠ 
--------------------------------------------------

typed_parameter ã®ç›´ä¸‹ã® type

.. literalinclude:: ../../samplecode/write-python-linter-rules/kotoha.yaml
   :language: yaml
   :lines: 3-8
   :emphasize-lines: 5-6

.. image:: ../_static/pyconshizu/ast-grep-playground-list-typed-parameter.png

ast-grepã¯å®Ÿã¯ **tree-sitter** ã«ã‚ˆã‚‹ ğŸƒâ€â™‚ï¸
--------------------------------------------------

    ast-grep's core is an algorithm to search and replace code based on abstract syntax tree produced by tree-sitter. 

* tree-sitter ã¯å¤šè¨€èªå¯¾å¿œ
* https://tree-sitter.github.io/tree-sitter/

tree-sitter ã‚¯ã‚¨ãƒªã®ä¾‹ [#tree-sitter-blog]_ ğŸƒâ€â™‚ï¸
------------------------------------------------------------

.. literalinclude:: ../../samplecode/write-python-linter-rules/kotoha.scm
   :language: scheme

.. [#tree-sitter-blog] æ‹™ãƒ–ãƒ­ã‚° `tree-sitterã§ã€é–¢æ•°ã®å¼•æ•°ã‚’listã§å‹ãƒ’ãƒ³ãƒˆã—ã¦ã„ã‚‹Pythonã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ã‚¨ãƒªã™ã‚‹ğŸ” <https://nikkie-ftnext.hatenablog.com/entry/tree-sitter-python-query-like-flake8-kotoha>`__

ğŸ…±ï¸ ç™ºå±•ï¼šRustã§æ›¸ã
==================================================

* ã“ã®éƒ¨åˆ†ã ã‘Rustã®çŸ¥è­˜ã‚’å‰æã«ã—ã¾ã™
* é›°å›²æ°—ã ã‘æ´ã‚“ã§ã„ãŸã ã‘ã‚Œã°ï¼

RustPython/Parser
--------------------------------------------------

* https://github.com/RustPython/Parser
* RustPythonãŒä½¿ã†Pythonãƒ‘ãƒ¼ã‚µï¼ˆRustè£½ï¼‰
* Ruffã‚‚ã‹ã¤ã¦ä½¿ã£ã¦ã„ãŸ [#ruff-040-blog]_

.. [#ruff-040-blog] https://astral.sh/blog/ruff-v0.4.0

Rustç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
--------------------------------------------------

* `rustup <https://rustup.rs/>`__ ã§Rustç’°å¢ƒã‚’å°å…¥
* :command:`cargo` ã§Rustã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç®¡ç†

    * Astralã¯Pythonã«ãŠã‘ã‚‹cargoã¨ã—ã¦uvã‚’ææ¡ˆã—ã¦ã„ã‚‹

Pythonã‚³ãƒ¼ãƒ‰ã‚’Rustã§ãƒ‘ãƒ¼ã‚¹
--------------------------------------------------

.. code-block:: rust

    use rustpython_parser::{Parse, ast};

    fn main() {
        let python_source = r#"
    def plus_one_ng(numbers: list[int]) -> list[int]:
        return [n + 1 for n in numbers]
    "#;
        let ast = ast::Suite::parse(python_source, "<embedded>");
        assert!(ast.is_ok());
        println!("{:#?}", ast.unwrap());
    }

RustPython/Parserã®AST
--------------------------------------------------

.. literalinclude:: ../../samplecode/write-python-linter-rules/lint-targets/rustpython-parser-output
   :lines: 3-49

rustpython-astã®visitor feature
--------------------------------------------------

.. code-block:: rust

    use rustpython_ast::{Arguments, Visitor};

    struct KotohaVisitor<'a> {
        source: &'a str,
    }

    impl Visitor for KotohaVisitor<'_> {
        fn visit_arguments(&mut self, node: Arguments) {
            // ã“ã“ã«å‡¦ç†ã‚’æ›¸ã
        }
    }

Pythonå®Ÿè£…ã¨åŒæ§˜ã®æŒ‡æ‘˜
--------------------------------------------------

.. code-block:: python

    def plus_one_ng(numbers: list[int]) -> list[int]:
        return [n + 1 for n in numbers]

    def plus_one_ok(numbers: Iterable[int]) -> list[int]:
        return [n + 1 for n in numbers]

.. code-block:: console

    $ cargo run -q
    Fix type hint `numbers: list[int]` at 2:17

å°ã¾ã¨ã‚ğŸ¥Ÿ Rustè£½ãƒªãƒ³ã‚¿ã«ãƒ«ãƒ¼ãƒ«ã‚’ã©ã†è¿½åŠ ã™ã‚‹ã‹
--------------------------------------------------

* ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒãªã„Ruffã‚’ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ã¨ä¸€ç·’ã«å‹•ã‹ã—ãŸã„
* **ast-grep**ï¼šRustè£½ãƒ„ãƒ¼ãƒ«ã§ã€YAMLã§ãƒ«ãƒ¼ãƒ«ã‚’æ›¸ã
* RustPython/Parserã‚’ä½¿ã£ã¦ **Rustã‚‚æ›¸ã„ã¦ã¿ãŸ** ï¼ˆç”ŸæˆAIã‚µãƒãƒ¼ãƒˆï¼‰

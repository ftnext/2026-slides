ãƒªãƒ³ã‚¿ã®ãƒ«ãƒ¼ãƒ«ã‚’Pythonã§æ›¸ã
=======================================

ãã®ãŸã‚ã«ã¾ãš2ã¤æŠ¼ã•ãˆã¾ã—ã‚‡ã†

* æŠ½è±¡æ§‹æ–‡æœ¨ï¼ˆ*AST*: Abstract Syntax Treeï¼‰
* GoF ã®ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã® *Visitor*

æº–å‚™1ï¸âƒ£ AST
==================================================

* ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ **æœ¨æ§‹é€ ** ã®ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦è¡¨ç¾ã—ãŸã‚‚ã®
* ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒˆãƒ¼ã‚¯ãƒ³ã«åˆ†ã‘ã‚‹
* ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ§‹æ–‡ã‚’è¡¨ã™æ§‹é€ ï¼ˆæœ¨ï¼‰ã«å¤‰æ›ã™ã‚‹

.. https://scrapbox.io/nikkie-memos/%E6%A7%8B%E6%96%87%E8%A7%A3%E6%9E%90%EF%BC%88%E3%80%8E%E3%82%B3%E3%83%B3%E3%83%94%E3%83%A5%E3%83%BC%E3%82%BF%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AE%E7%90%86%E8%AB%96%E3%81%A8%E5%AE%9F%E8%A3%85%E3%80%8F%EF%BC%89

æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã® ``ast`` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« [#ast-m]_
--------------------------------------------------

.. code-block::

    % echo 'print("é™å²¡")' | python -m ast
    Module(
    body=[
        Expr(
            value=Call(
                func=Name(id='print', ctx=Load()),
                args=[
                Constant(value='é™å²¡')]))])

.. [#ast-m] https://docs.python.org/ja/3/library/ast.html#command-line-usage

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ASTã«å¤‰æ› [#ast.parse]_
--------------------------------------------------

.. code-block:: pycon

    >>> import ast
    >>> tree = ast.parse('print("é™å²¡")')

.. [#ast.parse] https://docs.python.org/ja/3/library/ast.html#ast.parse

ASTã‚’è¡¨ç¤º [#ast.dump]_
--------------------------------------------------

.. code-block:: pycon

    >>> print(ast.dump(tree, indent=2))
    Module(
      body=[
        Expr(
          value=Call(
            func=Name(id='print', ctx=Load()),
            args=[
              Constant(value='é™å²¡')]))])

.. [#ast.dump] https://docs.python.org/ja/3/library/ast.html#ast.dump

``print("Hello")`` ã®ASTã‚’èª­ã‚€
--------------------------------------------------

* `ast.Module <https://docs.python.org/ja/3/library/ast.html#ast.Module>`__ ã® ``body`` ã«ã¯ `æ–‡ <https://docs.python.org/ja/3/library/ast.html#ast-statements>`__ ãŒæ¥ã‚‹

    é–¢æ•°å‘¼ã³å‡ºã—ã®ã‚ˆã†ãªå¼ãŒãã‚Œè‡ªèº«ã§æ–‡ã¨ãªã‚Šã€ï¼ˆ`ast.Expr <https://docs.python.org/ja/3/library/ast.html#ast.Expr>`__ï¼‰

.. revealjs-break::

* `ast.Call <https://docs.python.org/ja/3/library/ast.html#ast.Call>`__ï¼šé–¢æ•°å‘¼ã³å‡ºã—

    * ``func`` ã«çµ„ã¿è¾¼ã¿é–¢æ•°ã® ``print``
    * ``args`` ã«ä½ç½®å¼•æ•°

.. https://docs.python.org/ja/3/library/ast.html#ast.Name
.. https://docs.python.org/ja/3/library/ast.html#ast.Constant

.. TODO å›³ï¼ˆDraw.ioã‚„Mermaidï¼‰ã‚’å…¥ã‚ŒãŸã„

æº–å‚™2ï¸âƒ£ Visitor ãƒ‘ã‚¿ãƒ¼ãƒ³
==================================================

* ã‚„ã‚ŠãŸã„ã“ã¨ï¼šæœ¨ã®ä¸­ã®ç‰¹å®šã®ãƒãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘ãŸã„ï¼ˆä¾‹ï¼š``print`` é–¢æ•°ï¼‰
* æ“ä½œã‚’ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«æ›¸ã‹ãªã„
* æ“ä½œã‚’ **è¨ªå•è€…** ï¼ˆVisitorï¼‰ã«æ›¸ãã€ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¯è¨ªå•è€…ã‚’å—ã‘å…¥ã‚Œã‚‹ï¼ˆæ“ä½œã‚’è¿½åŠ ã—ã‚„ã™ããªã‚‹ï¼‰

.. https://nikkie-ftnext.hatenablog.com/entry/the-transcendent-book-chapter8-design-patterns-visitor

.. _ast.NodeVisitor: https://docs.python.org/ja/3/library/ast.html#ast.NodeVisitor

`ast.NodeVisitor`_
--------------------------------------------------

    æŠ½è±¡æ§‹æ–‡æœ¨ã‚’æ¸¡ã‚Šæ­©ã„ã¦ãƒ“ã‚¸ã‚¿ãƒ¼é–¢æ•°ã‚’è¦‹ã¤ã‘ãŸãƒãƒ¼ãƒ‰ã”ã¨ã«å‘¼ã³å‡ºã™ãƒãƒ¼ãƒ‰ãƒ»ãƒ“ã‚¸ã‚¿ãƒ¼ã®åŸºåº•ã‚¯ãƒ©ã‚¹ã§ã™ã€‚

**ç¶™æ‰¿** ã—ãŸã‚¯ãƒ©ã‚¹ã‚’å®Ÿè£…ã™ã‚‹

``print`` ã‚’è¦‹ã¤ã‘ã‚‹
--------------------------------------------------

.. literalinclude:: ../../samplecode/write-python-linter-rules/print_finder.py
    :language: python
    :pyobject: PrintFinder

``NodeVisitor`` ã‚’ç¶™æ‰¿ã—ãŸ ``PrintFinder``
--------------------------------------------------

* ``generic_visit``ï¼šå­ãƒãƒ¼ãƒ‰ã® ``visit`` ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ï¼ˆå†å¸°ï¼‰
* ``visit`` ã¯ãƒãƒ¼ãƒ‰ã®ã‚¯ãƒ©ã‚¹åã‹ã‚‰ ``visit_ã‚¯ãƒ©ã‚¹å`` ã‚’å‘¼ã³å‡ºã™

  * ``visit_Call`` ã§é–¢æ•°å‘¼ã³å‡ºã—ãƒãƒ¼ãƒ‰ï¼ˆ``ast.Call``ï¼‰ã®å‡¦ç†ã‚’å®Ÿè£…

å®Ÿè¡Œçµæœ
--------------------------------------------------

.. code-block:: python

    print("é™å²¡")
    len("é™å²¡")
    print("æœ€é«˜")

.. code-block:: txt

    Found print at line 1, args ['é™å²¡']
    Found print at line 3, args ['æœ€é«˜']

.. printé–¢æ•°ã®å‘¼ã³å‡ºã—ã®æŒ‡æ‘˜ã¯ç·´ç¿’å•é¡Œã¨ã—ã¦ï¼Ÿ

ãƒ«ãƒ¼ãƒ«ã‚’æ›¸ãæº–å‚™ã€OKï¼Ÿ
==================================================

:æŠ½è±¡æ§‹æ–‡æœ¨: ``ast`` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« 
:Visitorãƒ‘ã‚¿ãƒ¼ãƒ³: ``ast.NodeVisitor`` ã‚’ç¶™æ‰¿ã—ã¦ ``visit_ãƒãƒ¼ãƒ‰ã®ã‚¯ãƒ©ã‚¹å`` ã‚’å®Ÿè£…

ASTã®ãƒãƒ¼ãƒ‰ã‚’å·¡å›ã—ã¦ã€ç‰¹å®šã®æ¡ä»¶ã®ãƒãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã¾ã™ï¼

ã€Œå¼•æ•°ã®å‹ãƒ’ãƒ³ãƒˆã‚’listã«ã—ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€ã‚’æ›¸ã
==================================================

.. literalinclude:: ../../samplecode/write-python-linter-rules/kotoha.py
    :language: python
    :pyobject: ArgumentConcreteTypeHintChecker

é–¢æ•°å®šç¾©ã®ASTï¼ˆæŠœç²‹ï¼‰
--------------------------------------------------

.. code-block::

    FunctionDef(
      name='plus_one_ng',
      args=arguments(
        args=[
          arg(
            arg='numbers',
            annotation=Subscript(
              value=Name(id='list', ctx=Load()),
              slice=Name(id='int', ctx=Load()),
              ctx=Load()))]),

.. revealjs-break::

* `ast.FunctionDef <https://docs.python.org/ja/3/library/ast.html#ast.FunctionDef>`__
* ``ast.arguments`` ï¼ˆé–¢æ•°ã®å¼•æ•°ï¼‰ã®1ã¤1ã¤ã®å¼•æ•° `ast.arg <https://docs.python.org/ja/3/library/ast.html#ast.arg>`__

    * ``annotation`` ã«å‹ãƒ’ãƒ³ãƒˆ

``ast.arg.annotation`` ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
--------------------------------------------------

* ``None``: å‹ãƒ’ãƒ³ãƒˆãªã—ï¼ˆ ``def func(a)`` ï¼‰
* ``ast.Name``: å˜ç´”ãªå‹ï¼ˆ ``def func(b: int)`` ï¼‰
* **ast.Subscript**: ã‚¸ã‚§ãƒãƒªãƒƒã‚¯å‹ï¼ˆ ``def func(d: list[str])`` ï¼‰
* ``ast.Attribute``: ä¿®é£¾åï¼ˆ ``def func(tree: ast.AST)`` ï¼‰

å®Ÿè¡ŒçµæœğŸ™Œ
--------------------------------------------------

.. code-block:: python

    def plus_one_ng(numbers: list[int]) -> list[int]:
        return [n + 1 for n in numbers]

    def plus_one_ok(numbers: Iterable[int]) -> list[int]:
        return [n + 1 for n in numbers]

.. code-block:: txt

    Fix type hint `numbers: list[int]` at 1:16

å°ã¾ã¨ã‚ğŸ¥Ÿ ãƒªãƒ³ã‚¿ã®ãƒ«ãƒ¼ãƒ«ã‚’Pythonã§æ›¸ã
--------------------------------------------------

* ASTã¨Visitorãƒ‘ã‚¿ãƒ¼ãƒ³
* ``ast.NodeVisitor`` ã‚’ç¶™æ‰¿ã—ã¦ ``visit_ãƒãƒ¼ãƒ‰ã®ã‚¯ãƒ©ã‚¹å`` ã‚’å®Ÿè£…
* ã€Œå¼•æ•°ã®å‹ãƒ’ãƒ³ãƒˆã‚’listã«ã—ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€ãƒ«ãƒ¼ãƒ«ã‚’Pythonã§å®Ÿè£…ã§ããŸ

flake8ã«ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ ã™ã‚‹
==================================================

* å…ˆã®å®Ÿè£…ã‚’flake8ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«åˆã‚ã›ã‚‹ã ã‘
* Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ã

.. https://flake8.pycqa.org/en/latest/plugin-development/index.html

flake8ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
--------------------------------------------------

* ASTå‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ï¼šflake8ãŒãƒ‘ãƒ¼ã‚¹æ¸ˆã¿ã® ``ast.AST`` ã‚’æ¸¡ã—ã¦ãã‚Œã‚‹

    * ``__init__(self, tree: ast.AST)``: ASTã‚’å—ã‘å–ã‚‹
    
* ``run()`` ãƒ¡ã‚½ãƒƒãƒ‰: 4-tuple ``(è¡Œç•ªå·, åˆ—ç•ªå·, ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸, å‹)`` ã‚’ ``yield``

flale8ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«åˆã‚ã›ãŸå®Ÿè£…
--------------------------------------------------

.. code-block:: python

    class Flake8KotohaPlugin:
        def __init__(self, tree: ast.AST) -> None:
            self._tree = tree

        def run(self) -> Generator[tuple[int, int, str, Type[Any]], None, None]:
            checker = ArgumentConcreteTypeHintChecker()
            checker.visit(self._tree)

            for lineno, col_offset, message in checker.errors:
                yield (lineno, col_offset, message, type(self))

.. https://github.com/ftnext/kotoha-python-linter/blob/v0.1.1/src/kotoha/plugins.py

* ãƒã‚§ãƒƒã‚«ãƒ¼ã¯ ``print`` ã™ã‚‹ä»£ã‚ã‚Šã« ``self.errors`` ãƒªã‚¹ãƒˆã¸ã®è“„ç©ã«å¤‰æ›´

ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°ã¨é…å¸ƒ
--------------------------------------------------

.. code-block:: toml
    :caption: :file:`pyproject.toml` ï¼ˆæŠœç²‹ï¼‰

    [project]
    dependencies = ["flake8"]

    [project.entry-points."flake8.extension"]
    KTH = "kotoha.plugins:Flake8KotohaPlugin"

.. https://github.com/ftnext/kotoha-python-linter/blob/v0.1.1/pyproject.toml

å…¬é–‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸: `flake8-kotoha`_
--------------------------------------------------

.. code-block:: console

    $ uvx --with flake8-kotoha flake8 .
    example.py:1:14: KTH101 Type hint with abstract type `collections.abc.Iterable` or `collections.abc.Sequence`, instead of concrete type `list`

pylint ã§ã‚‚ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã—ã¦æ›¸ã‘ã‚‹
--------------------------------------------------

* pylint ã«ã‚‚ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ©Ÿæ§‹ãŒã‚ã‚‹
* flake8 ã¨åŒæ§˜ã«ã€pylint ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã—ã¦ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ ã§ãã‚‹ï¼ˆTODO è¦ç¢ºèªï¼‰

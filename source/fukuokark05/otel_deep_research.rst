==================================================
deep research ã®ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ OTel ã§è¦—ã
==================================================

:Event: ç¦å²¡Rubyistä¼šè­°05
:Presented: 2026/02/28 nikkie

ãŠå‰ã€èª°ã‚ˆï¼ˆPythonä½¿ã„ã®è‡ªå·±ç´¹ä»‹ï¼‰
==================================================

* æ±äº¬åœ¨ä½ã€‚æ©Ÿæ¢°å­¦ç¿’ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢
* `Speeda AI Agent <https://jp.ub-speeda.com/news/speeda-promotion-gallery/>`__ é–‹ç™ºï¼ˆdeep research æ©Ÿèƒ½å«ã‚€ï¼‰ [#hiring]_

.. image:: ../_static/uzabase-white-logo.png

.. [#hiring] `We're hiring! <https://hrmos.co/pages/uzabase/jobs/1829077236709650481>`__

ã‚‚ã†å°‘ã—è‡ªå·±ç´¹ä»‹
--------------------------------------------------

* ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰ `llm-deep-research <https://github.com/ftnext/llm-deep-research>`__ [#simonw-llm-plugin]_
* `Python Meetup Fukuoka <https://www.youtube.com/@lycorptech_jp/search?query=Python%20Meetup>`__ ãŒç†±ãã¦ğŸ”¥ãŸã³ãŸã³å‚åŠ ï¼ˆ`æ¬¡å›3/4 <https://lycorptech-fukuoka.connpass.com/event/380867/>`__ï¼‰
* ä»Šå›ã®ç™ºè¡¨ã‚’æ©Ÿã«ã€Rubyã¯5å¹´ä»¥ä¸Šã¶ã‚Š

.. [#simonw-llm-plugin] Simon Willisonã•ã‚“ã® `llm <https://pypi.org/project/llm/>`__ ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³

ã“ã®ä¸€å¹´ã€ä½•ã‚’ã—ã¦ã„ã¾ã—ãŸã‹ï¼Ÿ
==================================================

* ãƒ†ãƒ¼ãƒï¼š"æœ€è¿‘ã€ä½•ã—ã¦ã‚‹ï¼Ÿ"
* https://regional.rubykaigi.org/fukuoka05/

deep researchğŸ’«
==================================================

2025/02/02 OpenAI `Introducing deep research <https://openai.com/index/introducing-deep-research/>`__

.. æ—¥æœ¬èª https://openai.com/ja-JP/index/introducing-deep-research/

.. in-depth: å¾¹åº•çš„ãª

çš†ã•ã‚“ä½¿ã£ã¦ã¾ã™ã‹ï¼ŸğŸ™‹
--------------------------------------------------

* GPT (OpenAI)
* Geminiãƒ»Claudeãªã©ãªã© [#deep-research-services]_
* å…¬é–‹å®Ÿè£…ã‚’å‹•ã‹ã—ãŸ
* è‡ªä½œã—ã¦ã„ã‚‹

.. [#deep-research-services] X (Grok)ãƒ»Perplexity

.. ç¶²ç¾…ã™ã‚‹ã‚ˆã‚Šä»£è¡¨ä¾‹ã‚’1ã¤ãšã¤ç´¹ä»‹ã—ã¦ã¿ã‚‹

OpenAI deep research
--------------------------------------------------

.. image:: ../_static/fukuokark05/openai-deep-research-example.png

.. revealjs-break::
  :notitle:

1. äººé–“ãŒèª¿æŸ»ã‚’ä¾é ¼
2. LLMã‹ã‚‰è¿½åŠ ã§è³ªå• [#202602-deep-research-update]_
3. äººé–“ã‹ã‚‰å›ç­”
4. LLMãŒèª¿æŸ»ï¼ˆ10åˆ†ç¨‹åº¦ï¼‰
5. è©³ç´°ãªãƒ¬ãƒãƒ¼ãƒˆ

.. [#202602-deep-research-update] 2026/02ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒå…¥ã‚Šã¾ã—ãŸï¼ˆ`Deep research in ChatGPT <https://help.openai.com/en/articles/10500283-deep-research-in-chatgpt>`__ï¼‰

ç§ã® **ä»£ã‚ã‚Šã«Webã‚’èª¿æŸ»** ã—ã¦ãã¦ãã‚Œã‚‹ï¼
--------------------------------------------------

* èª¿æŸ»è¨ˆç”»
* Webæ¤œç´¢
* Webãƒ–ãƒ©ã‚¦ã‚¸ãƒ³ã‚°

.. æ‰‹å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«æŒ‡å®šã‚‚å¯

LLMã« **é“å…·ã‚’æ¸¡ã—ã¦** å†ç¾ã•ã›ã‚ˆã†ï¼
--------------------------------------------------

* OpenAIã¯ *å°‚ç”¨ãƒ¢ãƒ‡ãƒ«* ã§å®Ÿç¾ [#deep-research-model]_
* OpenAIã®ã‚ˆã†ã«å°‚ç”¨ãƒ¢ãƒ‡ãƒ«ã¯é–‹ç™ºã§ããšã¨ã‚‚
* LLMã¯é“å…·ãŒä½¿ãˆã‚‹ï¼ˆtool use = function callingï¼‰

.. [#deep-research-model] ã€Œ*The deep research model is powered by an early version of OpenAI o3 that is optimized for web browsing.*ã€ `Deep Research System Card <https://openai.com/index/deep-research-system-card/>`__

.. tool useã¯ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿç¾ã™ã‚‹è¦ç´ ã§ã‚‚ã‚ã‚‹

.. Googleã®è«–æ–‡ã‚ã£ãŸ

.. å°‚ç”¨ãƒ¢ãƒ‡ãƒ«ã‚’é–‹ç™ºã™ã‚‹è«–æ–‡ã‚‚ã‚ã‚‹ï¼ˆOpenAIã®ãƒ¢ãƒ‡ãƒ«ã‚ˆã‚Šã¯å°ã•ãªãƒ¢ãƒ‡ãƒ«ï¼‰

.. revealjs-break::
    :notitle:

.. raw:: html

    <iframe class="speakerdeck-iframe" style="border: 0px; background: rgba(0, 0, 0, 0.1) padding-box; margin: 0px; padding: 0px; border-radius: 6px; box-shadow: rgba(0, 0, 0, 0.2) 0px 5px 40px; width: 100%; height: auto; aspect-ratio: 560 / 315;" frameborder="0" src="https://speakerdeck.com/player/f912a0d061334d5aaf2fbf09ace3888c?slide=11" title="AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã¯ï¼ˆUB Tech vol.21ï¼‰" allowfullscreen="true" data-ratio="1.7777777777777777"></iframe>

.. revealjs-break::
    :notitle:

1. LLMã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨toolä¸€è¦§ã‚’é€ã‚‹
2. LLMã€Œã“ã®toolã‚’ã“ã‚Œã“ã‚Œã®å¼•æ•°ã§å‘¼ã³å‡ºã—ãŸã„ã€ï¼ˆJSONï¼‰
3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§toolã‚’å‘¼ã³å‡ºã—ã€çµæœã‚’LLMã«è¿”ã™
4. LLMãŒtoolã®çµæœã‚’å…ƒã«ï¼ˆå¿…è¦ã§ã‚ã‚Œã°ã•ã‚‰ã«toolå‘¼ã³å‡ºã—ï¼‰å›ç­”

.. _Open-source DeepResearch: https://huggingface.co/blog/open-deep-research

`Open-source DeepResearch`_
==================================================

* OpenAIã®ç™ºè¡¨ã‚’å—ã‘ã¦ã€Hugging FaceãŒ24æ™‚é–“å†ç¾ãƒãƒ£ãƒ¬ãƒ³ã‚¸
* https://github.com/huggingface/smolagents/tree/main/examples/open_deep_research

    This agent achieves **55% pass@1** on the GAIA [#gaia-paper]_ validation set, compared to **67%** for the original Deep Research.

.. [#gaia-paper] `[2311.12983] GAIA: a benchmark for General AI Assistants <https://arxiv.org/abs/2311.12983>`__

Hugging Faceè£½deep researchã®å·¥å¤«
--------------------------------------------------

* ãƒ†ã‚­ã‚¹ãƒˆãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆ*an extremely simple text-based web browser*ï¼‰
* CodeAct [#codeact-paper]_ ï¼šè¨ˆç”»ã‚’ã‚³ãƒ¼ãƒ‰ï¼ˆPythonï¼‰ã§è¡¨ç¾

.. [#codeact-paper] `[2402.01030] Executable Code Actions Elicit Better LLM Agents <https://arxiv.org/abs/2402.01030>`__

å…¬é–‹å®Ÿè£…ãŒæ¬¡ã€…ã«ç™»å ´
--------------------------------------------------

.. TODO Pydantic AIã€Strands

* ä¼æ¥­ï¼šLangChainãªã©
* ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£

æœ¬æ°—ã§æ¢ã›ã°100ä»¥ä¸Šï¼Ÿ

ç§ã¯å·¥å¤«ã‚’çŸ¥ã‚ŠãŸã„
--------------------------------------------------

* è‡ªä½œã®å‚è€ƒã«ã™ã‚‹ãŸã‚ã«å…¬é–‹å®Ÿè£…ã‚’å‹•ã‹ã™
* ä½œè€…ã§ã¯ãªã„ã®ã§ã€å†…éƒ¨ã®å‹•ããŒæ‰‹ã«å–ã‚‹ã‚ˆã†ã«ã¯ã‚ã‹ã‚‰ãªã„ï¼ˆ**ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹**ï¼‰

.. ä»Šãªã‚‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«èª¿ã¹ã¦ã‚‚ã‚‰ã†é¸æŠè‚¢ã‚ã‚Š

LLMã¸ã®å…¥åŠ›ã‚’å…¨éƒ¨åˆ†ã‹ã‚ŠãŸã„ï¼ˆæŸç¸›ç³»ï¼‰
--------------------------------------------------

* LLMã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã«ãŠã‘ã‚‹ç§ã®ä¿¡å¿µ
* deep researchã‚’ä¾é ¼ã•ã‚ŒãŸ **LLMã®ã‚ˆã†ã«è€ƒãˆã‚‹** [#think-like-agents]_
* æ”¹å–„æ¡ˆã‚’å‡ºã—ã‚„ã™ã„ï¼ˆLLMã‚ˆã‚Šå‰ã¯æ•°å­¦ã®ç†è§£ãŒå¿…è¦ã ã£ãŸï¼‰

.. [#think-like-agents] ã€Œ*Think like your agents*ã€ Anthropic `How we built our multi-agent research system <https://www.anthropic.com/engineering/built-multi-agent-research-system>`__

**OpenTelemetry** (OTel) ã«ç›®ã‚’ã¤ã‘ãŸï¼
==================================================

* ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªï¼ˆãƒˆãƒ¬ãƒ¼ã‚¹ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ»ãƒ­ã‚°ï¼‰ã‹ã‚‰ **å¯è¦³æ¸¬æ€§** ã‚’å¾—ã‚‹æ‰‹æ®µ

    * ã‚·ã‚¹ãƒ†ãƒ ã®å‡ºåŠ›ã‹ã‚‰å†…éƒ¨çŠ¶æ…‹ã‚’ç†è§£ã™ã‚‹

* ãƒ™ãƒ³ãƒ€ãƒ¼ã‚„ãƒ„ãƒ¼ãƒ«ã®ãƒ­ãƒƒã‚¯ã‚¤ãƒ³ãªã—

.. https://opentelemetry.io/ja/docs/what-is-opentelemetry/

.. ä»Šæœˆã®SoftwareDesignã€Œå†è€ƒãƒ»ãƒ­ã‚°è¨­è¨ˆã€ã€ã‚ˆã„ã§ã™... https://x.com/gihyosd/status/2027337725746315549

ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¼æ’­ğŸƒâ€â™‚ï¸ [#otel-context-propagation]_
------------------------------------------------------------

.. image:: ../_static/fukuokark05/otel-docs-context-propagation-example.svg

.. ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ä¾¿åˆ©

.. ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«IDã‚’ä»˜ä¸ã—ã¦åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚¹

.. [#otel-context-propagation] https://opentelemetry.io/ja/docs/concepts/context-propagation/#traces

ãƒˆãƒ¬ãƒ¼ã‚¹ä¾‹ğŸƒâ€â™‚ï¸
--------------------------------------------------

.. code-block:: json

  {
      "name": "GET /",
      "context": {
          "trace_id": "0x9591b67e3eb9f91ecadc84aec50e79f0",
          "span_id": "0x9bf997b809109fa3",
          "trace_state": "[]"
      },
      "kind": "SpanKind.SERVER",
      "parent_id": "0x119f828276ebd665",
      "start_time": "2026-02-27T10:57:22.142571Z",
      "end_time": "2026-02-27T10:57:22.143700Z",
      "status": {
          "status_code": "UNSET"
      },
      "attributes": {
          "http.scheme": "http",
          "http.host": "127.0.0.1:8000",
          "net.host.port": 8000,
          "http.flavor": "1.1",
          "http.target": "/",
          "http.url": "http://127.0.0.1:8000/",
          "http.method": "GET",
          "http.server_name": "localhost:8000",
          "http.user_agent": "Faraday v2.14.1",
          "net.peer.ip": "127.0.0.1",
          "net.peer.port": 62375,
          "http.route": "/",
          "http.status_code": 200
      },
      "events": [],
      "links": [],
      "resource": {
          "attributes": {
              "telemetry.sdk.language": "python",
              "telemetry.sdk.name": "opentelemetry",
              "telemetry.sdk.version": "1.35.0",
              "service.name": "unknown_service"
          },
          "schema_url": ""
      }
  }

ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åï¼šSemantic conventionsğŸƒâ€â™‚ï¸
--------------------------------------------------

* https://opentelemetry.io/docs/specs/semconv/
* LLMã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å‘ã‘ã®ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯è¦ç´„ç­–å®šãŒ **ç¾åœ¨é€²è¡Œç³»**

    * https://opentelemetry.io/docs/specs/semconv/gen-ai/

ä¾‹ãˆã° Gemini
--------------------------------------------------

* Pythonã§ã¯ `google-genai <https://pypi.org/project/google-genai/>`__ SDK
* OTelãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒ `opentelemetry-instrumentation-google-genai <https://pypi.org/project/opentelemetry-instrumentation-google-genai/>`__ ã§ *è¨ˆè£…* ã‚’æä¾›

æ‚©ã¾ã•ã‚Œã¦ã„ãŸãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
--------------------------------------------------

.. code-block:: python

    from deep_research_lib import ResearchAgent  # Geminiã‚’ä½¿ã£ãŸdeep research

    result = ResearchAgent().run(query)

google-genaiã‚’è¨ˆè£…ï¼ˆç°¡ç•¥ç‰ˆï¼‰
--------------------------------------------------

.. code-block:: python
    :emphasize-lines: 2,4

    from deep_research_lib import ResearchAgent
    from opentelemetry.instrumentation.google_genai import GoogleGenAiSdkInstrumentor

    GoogleGenAiSdkInstrumentor().instrument()
    result = ResearchAgent().run(query)

https://github.com/ftnext/2026-slides/tree/main/samplecode/deep-research-otel/python

.. Geminiã¸ã®å…¥åŠ›ãŒè¦‹ã‚‰ã‚ŒãŸ

å›ç­”ï¼šã“ã®ä¸€å¹´ã€ä½•ã‚’ã—ã¦ã„ã¾ã—ãŸã‹ï¼Ÿ
==================================================

* deep researchã®å®Ÿè£…ã‚’è¦‹ã¤ã‘ã‚‹
* OpenTelemetryã‚’æœ‰åŠ¹ã«ã—ã¦å‹•ã‹ã™ï¼ˆé‘‘è³ï¼‰
* æ°—ã«ãªã‚‹ç®‡æ‰€ã®ã‚½ãƒ¼ã‚¹ã‚’èª­ã¿ç†è§£æ·±ã‚ã‚‹ï¼ˆè‡ªåˆ†ã®å®Ÿè£…ã«æ´»ã‹ã™ï¼‰

ã“ã‚Œã‚’ **Ruby** ã§ã‚„ã‚‹ã“ã¨ã‚’è€ƒãˆã¾ã™
==================================================

https://github.com/ftnext/2026-slides/tree/main/samplecode/deep-research-otel

ä»Šå›ã®deep research
--------------------------------------------------

1. topic_generator
2. topic_researcher
3. research_synthesizer

.. uvx --with llm-deep-research llm -m genai-processors-research 'Research the best things about owning dalmatians!'

.. TODO å›³

Gemini APIã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«Faraday
--------------------------------------------------

.. code-block:: ruby

    conn = Faraday.new(
      url: "https://generativelanguage.googleapis.com"
    )
    response = conn.post(
      "/v1beta/models/gemini-3-flash-preview:generateContent"
    ) do |req|
      req.headers["Content-type"] = "application/json"
      req.headers["x-goog-api-key"] = api_key
      req.body = {
        contents: [
          {
            parts: [
              { text: "What's a good name for a flower shop that specializes in selling bouquets of dried flowers?" }
            ]
          }
        ]
      }.to_json
    end

opentelemetry-instrumentation-faraday
--------------------------------------------------

.. code-block:: ruby

    ENV["OTEL_TRACES_EXPORTER"] = "console"
    OpenTelemetry::SDK.configure do |c|
      c.use 'OpenTelemetry::Instrumentation::Faraday'
    end

é™ç•Œï¼šGemini APIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä¸æ˜
--------------------------------------------------

.. code-block:: ruby
    :caption: ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã¯è¨˜éŒ²ã•ã‚Œãªã„

    ENV["OTEL_TRACES_EXPORTER"] = "console"
    OpenTelemetry::SDK.configure do |c|
      c.use 'OpenTelemetry::Instrumentation::Faraday'
    end

    agent = ResearchAgent.new(api_key: api_key, config: config)
    result = agent.run(USER_QUERY)

Workaround: faradayã®Middlewareï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰
--------------------------------------------------

.. code-block:: ruby

  class OtelBodyCaptureMiddleware < Faraday::Middleware
    def call(env)
      # span.set_attribute("http.request.body", body_str)
    end
  end

  agent = ResearchAgent.new(api_key: api_key, config: config) do |conn|
    conn.builder.insert_after(
      OpenTelemetry::Instrumentation::Faraday::Middlewares::Old::TracerMiddleware,
      OtelBodyCaptureMiddleware
    )
  end

google-genaiã‚’è¨ˆè£…ã™ã‚‹ä½“é¨“ã‚’ã—ãŸã„ï¼
==================================================

.. code-block:: python
    :emphasize-lines: 2,4

    from deep_research_lib import ResearchAgent
    from opentelemetry.instrumentation.google_genai import GoogleGenAiSdkInstrumentor

    GoogleGenAiSdkInstrumentor().instrument()
    result = ResearchAgent().run(query)

ã‚¹ã‚³ãƒ¼ãƒ—ã‚’çµã£ã¦è‡ªä½œ
--------------------------------------------------

.. code-block:: ruby

    require_relative './deep_research_lib'
    require_relative './instrumentor'

    MyGoogleGenai::Instrumentation::Instrumentor.new.instrument
    result = ResearchAgent.new(api_key: api_key, config: config).run(USER_QUERY)

.. v2ã¸ã®ãƒªãƒ³ã‚¯

LLMã¸ã®å…¥åŠ›ã€å…¨éƒ¨åˆ†ã‹ã‚‹ï¼ğŸ™Œ
--------------------------------------------------

.. code-block:: txt

   events=
    [#<struct OpenTelemetry::SDK::Trace::Event
      name="gen_ai.user.message",
      attributes=
       {"content" =>
         "You are an expert at generating topics for research, based on the user's content.\n" +
         "\n" +
         "Your first task is to devise a number of concrete research areas needed to address the user's content.\n" +
         "\n" +

æœ€å¾Œã«ï¼šdeep researchã‚’ä½œã£ã¦ã¿ãŸããªã£ãŸæ–¹ã¸
==================================================

* è‡ªä½œä»¥å¤–ã«ï¼šGoogleã¯interactions APIã¨ã—ã¦deep researchã‚’æä¾›ã—ã¦ã„ã¾ã™
* è‡ªä½œã™ã‚‹å ´åˆï¼šã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒãƒ¼ãƒã‚¹ã‚’ä½¿ã†ï¼ˆClaude Code SDKãªã©ï¼‰

ã”æ¸…è´ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ
--------------------------------------------------

deep research ã®ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ OTel ã§è¦—ã

.. ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰tool use
